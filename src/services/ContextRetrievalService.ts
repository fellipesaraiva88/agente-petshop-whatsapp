import { CustomerMemoryDB } from './CustomerMemoryDB';

/**
 * CONTEXTO COMPLETO RECUPERADO
 * Snapshot de tudo que sabemos sobre o cliente
 */
export interface ContextSnapshot {
  // Identidade
  tutor: {
    tutorId: string;
    nome: string;
    estiloComum: string;
    arquetipoFrequente: string;
    horarioPreferido?: string;
    metodoPagamentoPreferido?: string;
  } | null;

  // Pets
  pets: Array<{
    petId: string;
    nome: string;
    especie: string;
    raca?: string;
    porte?: string;
    idade?: number;
    temperamento?: string;
    ultimoServico?: Date;
    proximaVacina?: Date;
  }>;

  // Hist√≥rico Emocional (√∫ltimas 5 emo√ß√µes)
  ultimasEmocoes: Array<{
    emocao: string;
    intensidade: number;
    data: Date;
    contexto?: string;
  }>;

  // Contexto de Neg√≥cio
  servicosAnteriores: Array<{
    tipo: string;
    data: Date;
    satisfacao?: number;
    valor?: number;
  }>;

  // Prefer√™ncias Aprendidas
  preferencias: {
    horario?: string;
    comunicacao?: string;
    preco?: string;
    servicos?: string[];
  };

  // √öltima Conversa
  ultimaConversa?: {
    data: Date;
    resultado: string;
    intencao: string;
    valorVenda?: number;
    proximoPasso?: string;
  };

  // Estat√≠sticas
  stats: {
    totalServicos: number;
    valorTotalGasto: number;
    satisfacaoMedia?: number;
    diasDesdeUltimoServico?: number;
    conversoes: number;
    taxaConversao: number;
  };

  // Flags importantes
  flags: {
    clienteNovo: boolean;
    clienteVip: boolean;
    clienteInativo: boolean;
    onboardingCompleto: boolean;
    temProximaAcao: boolean;
  };
}

/**
 * SERVI√áO DE RECUPERA√á√ÉO DE CONTEXTO CROSS-SESSION
 * Carrega TUDO que sabemos sobre um cliente para contextualizar conversa
 */
export class ContextRetrievalService {
  constructor(private memoryDB: CustomerMemoryDB) {}

  /**
   * Recupera snapshot completo de contexto
   */
  public async getFullContext(chatId: string): Promise<ContextSnapshot> {
    // TODO: Migrar para PostgreSQL via CustomerMemoryDB
    // As tabelas necess√°rias (tutors, pets, emotional_context, service_history,
    // conversation_episodes, learned_preferences) n√£o existem no PostgreSQL atual
    throw new Error('TODO: Migrar getFullContext para PostgreSQL - tabelas ainda n√£o existem');
  }

  /**
   * Recupera dados do tutor
   * TODO: Migrar para PostgreSQL - tabela 'tutors' n√£o existe
   */
  private getTutorData(chatId: string): ContextSnapshot['tutor'] {
    // TODO: Implementar usando CustomerMemoryDB quando tabela tutors existir
    return null;
  }

  /**
   * Recupera dados dos pets
   * TODO: Migrar para PostgreSQL - tabela 'pets' n√£o existe
   */
  private getPetsData(tutorId?: string): ContextSnapshot['pets'] {
    // TODO: Implementar usando CustomerMemoryDB quando tabela pets existir
    return [];
  }

  /**
   * Recupera hist√≥rico emocional
   * TODO: Migrar para PostgreSQL - tabela 'emotional_context' n√£o existe
   */
  private getEmotionalHistory(chatId: string): ContextSnapshot['ultimasEmocoes'] {
    // TODO: Implementar usando CustomerMemoryDB quando tabela emotional_context existir
    return [];
  }

  /**
   * Recupera hist√≥rico de servi√ßos
   * TODO: Migrar para PostgreSQL - tabela 'service_history' n√£o existe
   */
  private getServiceHistory(tutorId?: string): ContextSnapshot['servicosAnteriores'] {
    // TODO: Implementar usando CustomerMemoryDB quando tabela service_history existir
    return [];
  }

  /**
   * Recupera prefer√™ncias aprendidas
   * TODO: Migrar para PostgreSQL - tabela 'learned_preferences' n√£o existe
   */
  private getPreferences(tutorId?: string): ContextSnapshot['preferencias'] {
    // TODO: Implementar usando CustomerMemoryDB quando tabela learned_preferences existir
    return {};
  }

  /**
   * Recupera √∫ltima conversa
   * TODO: Migrar para PostgreSQL - tabela 'conversation_episodes' n√£o existe
   */
  private getLastConversation(chatId: string): ContextSnapshot['ultimaConversa'] {
    // TODO: Implementar usando CustomerMemoryDB quando tabela conversation_episodes existir
    return undefined;
  }

  /**
   * Calcula estat√≠sticas
   * TODO: Migrar para PostgreSQL - depende de tabelas n√£o existentes
   */
  private getStats(
    tutorId: string | undefined,
    servicosAnteriores: ContextSnapshot['servicosAnteriores']
  ): ContextSnapshot['stats'] {
    // TODO: Implementar usando CustomerMemoryDB quando tabelas existirem
    return {
      totalServicos: 0,
      valorTotalGasto: 0,
      satisfacaoMedia: undefined,
      diasDesdeUltimoServico: undefined,
      conversoes: 0,
      taxaConversao: 0
    };
  }

  /**
   * Gera flags importantes
   */
  private generateFlags(
    tutor: ContextSnapshot['tutor'],
    pets: ContextSnapshot['pets'],
    stats: ContextSnapshot['stats'],
    ultimaConversa?: ContextSnapshot['ultimaConversa']
  ): ContextSnapshot['flags'] {
    const clienteNovo = stats.totalServicos === 0;
    const clienteVip = stats.valorTotalGasto > 1000 || (stats.satisfacaoMedia || 0) >= 4.5;
    const clienteInativo = (stats.diasDesdeUltimoServico || 0) > 60;
    const onboardingCompleto = !!tutor && pets.length > 0;
    const temProximaAcao = pets.some(p =>
      p.proximaVacina && p.proximaVacina.getTime() - Date.now() < 7 * 24 * 60 * 60 * 1000
    );

    return {
      clienteNovo,
      clienteVip,
      clienteInativo,
      onboardingCompleto,
      temProximaAcao
    };
  }

  /**
   * Formata contexto em string para prompt da IA
   */
  public formatContextForPrompt(context: ContextSnapshot): string {
    let prompt = '\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
    prompt += 'üß† CONTEXTO COMPLETO DO CLIENTE\n';
    prompt += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';

    // ‚è∞ HOR√ÅRIO LOCAL (Florian√≥polis, BR - GMT-3)
    const agora = new Date();
    const horaBrasil = new Date(agora.toLocaleString('en-US', { timeZone: 'America/Sao_Paulo' }));
    const hora = horaBrasil.getHours();
    const minuto = horaBrasil.getMinutes().toString().padStart(2, '0');
    const diaSemana = ['domingo', 'segunda', 'ter√ßa', 'quarta', 'quinta', 'sexta', 's√°bado'][horaBrasil.getDay()];
    const dia = horaBrasil.getDate();
    const mes = ['janeiro', 'fevereiro', 'mar√ßo', 'abril', 'maio', 'junho', 'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'][horaBrasil.getMonth()];

    let perioDo = 'madrugada';
    if (hora >= 6 && hora < 12) perioDo = 'manh√£';
    else if (hora >= 12 && hora < 18) perioDo = 'tarde';
    else if (hora >= 18 && hora < 22) perioDo = 'noite';

    prompt += `‚è∞ AGORA: ${diaSemana}, ${dia} de ${mes} - ${hora}:${minuto} (${perioDo})\n`;
    prompt += `   Importante: Ajuste seu tom e energia ao per√≠odo do dia!\n\n`;

    // TUTOR
    if (context.tutor) {
      prompt += `üë§ TUTOR: ${context.tutor.nome}\n`;
      prompt += `   Estilo de comunica√ß√£o: ${context.tutor.estiloComum}\n`;
      prompt += `   Arqu√©tipo frequente: ${context.tutor.arquetipoFrequente}\n`;
      if (context.tutor.horarioPreferido) {
        prompt += `   Hor√°rio preferido: ${context.tutor.horarioPreferido}\n`;
      }
      if (context.tutor.metodoPagamentoPreferido) {
        prompt += `   Pagamento preferido: ${context.tutor.metodoPagamentoPreferido}\n`;
      }
      prompt += '\n';
    }

    // PETS
    if (context.pets.length > 0) {
      prompt += `üêæ PETS:\n`;
      context.pets.forEach(pet => {
        prompt += `   ‚Ä¢ ${pet.nome}`;
        if (pet.raca) prompt += ` (${pet.raca})`;
        if (pet.idade) prompt += ` - ${pet.idade} anos`;
        if (pet.temperamento) prompt += ` - temperamento: ${pet.temperamento}`;
        prompt += '\n';
        if (pet.ultimoServico) {
          const diasAtras = Math.floor((Date.now() - pet.ultimoServico.getTime()) / (1000 * 60 * 60 * 24));
          prompt += `     √öltimo servi√ßo: h√° ${diasAtras} dias\n`;
        }
        if (pet.proximaVacina) {
          prompt += `     ‚ö†Ô∏è Vacina pr√≥xima: ${pet.proximaVacina.toLocaleDateString()}\n`;
        }
      });
      prompt += '\n';
    }

    // HIST√ìRICO EMOCIONAL
    if (context.ultimasEmocoes.length > 0) {
      prompt += `üí≠ HIST√ìRICO EMOCIONAL:\n`;
      context.ultimasEmocoes.slice(0, 3).forEach(e => {
        prompt += `   ‚Ä¢ ${e.emocao} (intensidade: ${e.intensidade}%)`;
        if (e.contexto) prompt += ` - ${e.contexto}`;
        prompt += '\n';
      });
      prompt += '\n';
    }

    // PREFER√äNCIAS
    if (Object.keys(context.preferencias).length > 0) {
      prompt += `üéØ PREFER√äNCIAS:\n`;
      if (context.preferencias.horario) {
        prompt += `   ‚Ä¢ Hor√°rio: ${context.preferencias.horario}\n`;
      }
      if (context.preferencias.comunicacao) {
        prompt += `   ‚Ä¢ Comunica√ß√£o: ${context.preferencias.comunicacao}\n`;
      }
      if (context.preferencias.preco) {
        prompt += `   ‚Ä¢ Pre√ßo: ${context.preferencias.preco}\n`;
      }
      if (context.preferencias.servicos && context.preferencias.servicos.length > 0) {
        prompt += `   ‚Ä¢ Servi√ßos favoritos: ${context.preferencias.servicos.join(', ')}\n`;
      }
      prompt += '\n';
    }

    // √öLTIMA CONVERSA
    if (context.ultimaConversa) {
      const diasAtras = Math.floor((Date.now() - context.ultimaConversa.data.getTime()) / (1000 * 60 * 60 * 24));
      prompt += `üí¨ √öLTIMA CONVERSA: h√° ${diasAtras} dias\n`;
      prompt += `   Inten√ß√£o: ${context.ultimaConversa.intencao}\n`;
      prompt += `   Resultado: ${context.ultimaConversa.resultado}\n`;
      if (context.ultimaConversa.proximoPasso) {
        prompt += `   ‚ö†Ô∏è Pr√≥ximo passo: ${context.ultimaConversa.proximoPasso}\n`;
      }
      prompt += '\n';
    }

    // ESTAT√çSTICAS
    prompt += `üìä ESTAT√çSTICAS:\n`;
    prompt += `   Total de servi√ßos: ${context.stats.totalServicos}\n`;
    prompt += `   Valor total gasto: R$ ${context.stats.valorTotalGasto.toFixed(2)}\n`;
    if (context.stats.satisfacaoMedia) {
      prompt += `   Satisfa√ß√£o m√©dia: ${context.stats.satisfacaoMedia.toFixed(1)}/5\n`;
    }
    prompt += `   Taxa de convers√£o: ${(context.stats.taxaConversao * 100).toFixed(0)}%\n`;
    prompt += '\n';

    // FLAGS IMPORTANTES
    prompt += `üö© FLAGS:\n`;
    if (context.flags.clienteNovo) prompt += `   ‚ö†Ô∏è CLIENTE NOVO - primeira vez\n`;
    if (context.flags.clienteVip) prompt += `   ‚≠ê CLIENTE VIP - tratamento especial\n`;
    if (context.flags.clienteInativo) prompt += `   ‚ö†Ô∏è CLIENTE INATIVO - reativar!\n`;
    if (!context.flags.onboardingCompleto) prompt += `   ‚ö†Ô∏è ONBOARDING INCOMPLETO - coletar dados\n`;
    if (context.flags.temProximaAcao) prompt += `   ‚ö†Ô∏è TEM A√á√ÉO PENDENTE - lembrar cliente\n`;

    prompt += '\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
    prompt += 'USE ESTE CONTEXTO PARA PERSONALIZAR SUA RESPOSTA!\n';
    prompt += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';

    return prompt;
  }
}
